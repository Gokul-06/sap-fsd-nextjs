generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Fsd {
  id                  String    @id @default(cuid())
  title               String
  projectName         String
  author              String
  companyName         String?
  primaryModule       String
  processArea         String
  relatedModules      String    @default("[]")
  markdown            String    @db.Text
  warnings            String    @default("[]")
  aiEnabled           Boolean   @default(true)
  shareId             String?   @unique
  shareExpiresAt      DateTime?
  docxBlobUrl         String?
  rating              Int?      // 1-5 stars (Level 3)
  usedFeedbackRuleIds String    @default("[]") // JSON array of rule IDs used in generation
  usedFewShotFsdIds   String    @default("[]") // JSON array of FSD IDs used as few-shot examples
  language            String    @default("English")
  fsdType             String    @default("standard") // standard | enhancement | interface | report | form | conversion | workflow
  isTemplate          Boolean   @default(false)
  industry            String?   // "Manufacturing" | "Pharma" | "Retail" | "Automotive" | "Utilities" | "Public Sector"
  calmProjectId       String?
  calmProjectName     String?
  calmRequirementIds  String    @default("[]")
  calmDocumentId      String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  comments            Comment[]

  @@index([isTemplate, primaryModule])
  @@index([createdAt])                   // History sorting — avoids full scan
  @@index([primaryModule, createdAt])    // Module-filtered lists — composite index
  @@index([rating])                      // "Best rated" queries
}

model Comment {
  id         String   @id @default(cuid())
  fsdId      String
  fsd        Fsd      @relation(fields: [fsdId], references: [id], onDelete: Cascade)
  authorName String   @default("Anonymous")
  content    String   @db.Text
  createdAt  DateTime @default(now())
}

model FeedbackRule {
  id              String   @id @default(cuid())
  module          String
  processArea     String?
  ruleType        String   // "content_improvement" | "structure" | "validation" | "terminology"
  content         String   @db.Text
  source          String   // "comment" | "manual" | "ai_extracted"
  sourceCommentId String?
  active          Boolean  @default(true)
  appliedCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([module, processArea])
  @@index([active])
  @@index([appliedCount])                // Hot rule ranking — most-used first
}

model AgentTraining {
  id                String   @id @default(cuid())
  agentRole         String   @unique // "project-director" | "business-analyst" | "solution-architect" | "technical-consultant" | "project-manager" | "bpmn-architect"
  expertName        String   // Name of the real person this is based on
  questionnaire     String   @db.Text  // JSON: { question: answer } pairs
  personalityPrompt String   @db.Text  // AI-compiled personality instruction
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([agentRole, isActive])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // CREATE_FSD, DELETE_FSD, EXPORT_DATA, SHARE_FSD, RATE_FSD, CREATE_COMMENT, etc.
  resource   String   // Fsd, Comment, FeedbackRule
  resourceId String?
  details    String?  @db.Text
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@index([action, timestamp])
}
